



> ***æ”¯æŒæ¨¡ç³ŠæŸ¥æ‰¾ï¼***<span id="MSG" style="color:red"></span>


```dataviewjs
// ä¹¦åº“è·¯å¾„
let BookLibPath = dv.pages(`#path`).filter(p=>String(p.file.path).includes("BookLibPath"))[0].BookLibPath;
// console.log(BookLibPath);

// æŸ¥è¯¢ä¹¦

// ä¹¦å input
dv.span("&nbsp;&nbsp;");
dv.span("ä¹¦å(å…³é”®å­—): ");
let eleName = dv.el("input");
eleName.style.width = "120px";

// ä½œè€… input
dv.span("&nbsp;&nbsp;");
dv.span("ä½œè€…(å…³é”®å­—): ");
let eleAuther = dv.el("input");
eleAuther.style.width = "120px";

// ISBN ç²¾ç¡®æŸ¥æ‰¾
dv.span("&nbsp;&nbsp;");
dv.span("ISBN(ç²¾ç¡®): ");
let eleIsbn = dv.el("input");
eleIsbn.style.width = "120px";

// çŠ¶æ€é€‰é¡¹ æƒ³è¯» åœ¨è¯» è¯»è¿‡
dv.span("&nbsp;&nbsp;");
dv.span("çŠ¶æ€: ");
const statusOptionsText = ["æ‰€æœ‰","æƒ³è¯»", "åœ¨è¯»", "è¯»è¿‡"];
const statusOptionsValue = ["","æƒ³è¯»","åœ¨è¯»","è¯»è¿‡"];
const statusDropdown = this.container.createEl("select");
const statusOption = [];
for(let i = 0;i<statusOptionsText.length;i++)
{
	statusOption[i] = statusDropdown.createEl("option");
	statusOption[i].text = statusOptionsText[i];
	statusOption[i].value = statusOptionsValue[i];
}


// ç±»åˆ«  
dv.span("&nbsp;&nbsp;");
dv.span("æ ‡ç­¾: ");
const typeOptionsText = ["æ‰€æœ‰","é©¬å…‹æ€ä¸»ä¹‰","å¿ƒç†å­¦","ç»æµ","æ–‡å­¦","å†å²","äººç‰©ä¼ è®°","æ•°å­¦","ç‰©ç†","è®¡ç®—æœºæŠ€æœ¯","ç”µä¿¡æŠ€æœ¯"];
const typeOptionsValue = ["","é©¬å…‹æ€ä¸»ä¹‰","å¿ƒç†å­¦","ç»æµ","æ–‡å­¦","å†å²","äººç‰©ä¼ è®°","æ•°å­¦","ç‰©ç†","è®¡ç®—æœºæŠ€æœ¯","ç”µä¿¡æŠ€æœ¯"];
const typeDropdown = this.container.createEl("select");
const typeOption = [];
for(let i = 0;i<typeOptionsText.length;i++)
{
	typeOption[i] = typeDropdown.createEl("option");
	typeOption[i].text = typeOptionsText[i];
	typeOption[i].value = typeOptionsValue[i];
}



// query button æœç´¢æŒ‰é”®
dv.span("&nbsp;&nbsp;");
let eleBtn = dv.el("button","æœç´¢")

dv.span("<br><br>");

function msg(sMsg) {
  new Notice(sMsg);
  MSG.innerText = sMsg;
}

eleBtn.onfocus = function() {
  MSG.innerText = "";
}


// æŸ¥è¯¢
eleBtn.onclick = async function() {
	// æ¸…é™¤ä¹‹å‰çš„table
	var table = document.querySelector('.dataview.table-view-table');
	if (table) {
	  // è·å–è¡¨æ ¼å…ƒç´ çš„çˆ¶èŠ‚ç‚¹
	  var parent = table.parentNode;
	  // è·å–çˆ¶èŠ‚ç‚¹çš„ä¸Šä¸€çº§èŠ‚ç‚¹ï¼ˆå³ç¥–çˆ¶èŠ‚ç‚¹ï¼‰
	  var grandparent = parent.parentNode;
	  // ä»ç¥–çˆ¶èŠ‚ç‚¹ä¸­ç§»é™¤çˆ¶èŠ‚ç‚¹
	  grandparent.removeChild(parent);
	}
	
	let data = [] // åŸå§‹æ•°æ®
	let bookPages = [] // ä¹¦
	let bookTable = [] // ä¹¦è¡¨æ ¼
	let bookViewTable = [] // å‘ˆç°å‡ºçš„ä¹¦è¡¨æ ¼
	try {
		let sName = "";   // ä¹¦ååŒ¹é…å­—ç¬¦ä¸²
		let sAuther = ""; // ä½œè€…
		let sIsbn = "";   // ISBN
		if(eleName.value != "") // åˆ¤ç©º
		{
			sName = eleName.value; 
		}
		if(eleAuther.value != "") // åˆ¤ç©º
		{
			sAuther = eleAuther.value;
		}
		if(eleIsbn.value != "") // åˆ¤ç©º
		{
			sIsbn = eleIsbn.value; 
		}
		
		// è·å¾—å¯é€‰æ¡†çš„å€¼
		const statusSelectedValue = statusDropdown.value;
		const typeSelectedValue = typeDropdown.value;

		// æ‹¿åˆ°é¡µé¢çš„æ•°æ®
		data = dv.pages(`"${BookLibPath}" and #ä¹¦ç±`)
		.filter(p=>String(p.file.name).includes(sName))
			.filter(p=>String(p.ä½œè€…).includes(sAuther))
			.filter(p=>String(p.tags).includes(typeSelectedValue))
			.filter(p=>String(p.ISBN).includes(sIsbn));
		bookPages = data;
		// console.log(bookPages.length);
		// éå†è·å– å…¥é“¾æ•°é‡ è¿™æ ·å¯ä»¥æŸ¥åˆ°æ˜¯å¦è¯»è¿‡
		let bookReadStatusArray = []; // é˜…è¯»çŠ¶æ€æ•°ç»„
		let bookReadTimesArray = [];  // é˜…è¯»æ¬¡æ•°æ•°ç»„
		for(let i=0;i<bookPages.length;i++)
		{
			
			// é˜…è¯»çŠ¶æ€ 0 æ‰€æœ‰ 1 æƒ³è¯» 2 åœ¨è¯» 3 è¯»è¿‡
			let readStatus = 1; // é˜…è¯»çŠ¶æ€ ä¸´æ—¶
			let readTimes = 0;  // é˜…è¯»æ¬¡æ•° ä¸´æ—¶
			// éå†æ¯æœ¬ä¹¦çš„å…¥é“¾
			for(let j=0;j<bookPages[i].file.inlinks.length;j++)
			{
				// æ‹¿åˆ°å…¥é“¾çš„è·¯å¾„
				let inlinkPath = bookPages[i].file.inlinks[j].path; 
				// console.log(inlinkPath);
				// åˆ¤æ–­å…¥é“¾æ˜¯å¦åˆè§„
				let isValidInlink = 0;
				let isValidMatch = inlinkPath.match(/\d{4}å¹´è¯»ä¹¦æ¸…å•/);
				isValidInlink = isValidMatch?isValidMatch.length:0;
				// ä¸åˆè§„è·³è¿‡æœ¬æ¬¡å¾ªç¯
				if(isValidInlink == 0) 
				{continue;}
				// å¼€å§‹æ£€æŸ¥é‡Œé¢çš„å†…å®¹ï¼Œå…ˆè·å–ä¸€ä¸‹æœ¬ä¹¦çš„è·¯å¾„
				let thisFilePath = bookPages[i].file.path.replace(/\s+/g, '%20');
				// let thisFilePath = bookPages[i].file.link.path;
				// console.log(thisFilePath);
				// è·å–å…¥é“¾é‡Œé¢çš„å†…å®¹
				let inlinkFileContent = await dv.io.load(inlinkPath);
				
				// åŒ¹é…å‡º å®Œæˆæ¸…å•çš„æ•°é‡ï¼Œæ²¡æœ‰å®Œæˆæ¸…å•çš„æ•°é‡
				// æ²¡æœ‰å®Œæˆ æ­£åœ¨åš
				// åŠ¨æ€æ­£åˆ™è¡¨è¾¾å¼
				let onregex = new RegExp("- \\[ \\] .*\\(" + thisFilePath + "\\).*$", "gm");
				let onmatch = inlinkFileContent.match(onregex);
				let onNum = onmatch?onmatch.length:0;
				// å®Œæˆ
				let okregex = new RegExp("- \\[x] .*\\(" + thisFilePath + "\\).*$", "gm");
				let okmatch = inlinkFileContent.match(okregex);
				let okNum = okmatch?okmatch.length:0;

				// ç´¯ç§¯è¯»çš„æ¬¡æ•°
				readTimes += okNum;
				// console.log("è¯»å®Œä¹¦æ•°é‡"+okNum);
				// console.log("æ­£åœ¨è¯»æ•°é‡"+onNum);
				// æœ‰æ­£åœ¨è¯»çš„
				if(onNum)
				{
					readStatus = 2;// åœ¨è¯»
				}
			}
			// é˜…è¯»æ¬¡æ•°è¶…è¿‡0 ä¸”ä¸åœ¨è¯» å°±æ˜¯è¯»è¿‡
			if(readTimes && readStatus != 2)
			{
				readStatus = 3;
			}
			bookReadStatusArray.push(readStatus); // é˜…è¯»çŠ¶æ€
			bookReadTimesArray.push(readTimes); // é˜…è¯»æ¬¡æ•°
			// console.log("é˜…è¯»çŠ¶æ€"+readStatus);
			// console.log("é˜…è¯»æ¬¡æ•°"+readTimes);

		}
		// åˆå§‹è¡¨æ ¼
		bookTable = data.map(p => ["![|60]("+ p.å°é¢ +")",p.file.link,p.ä½œè€…,p.è±†ç“£è¯„åˆ†,p.æ€»é¡µæ•°,p.file.etags]);
		
		// é‡æ–°æ’å¸ƒbookTable æ ¹æ®çŠ¶æ€ç­›é€‰ statusSelectedValue
		// console.log(statusSelectedValue);
		let selectStatus = 0; // æ‰€æœ‰
		if(statusSelectedValue === "")
			selectStatus = 0;
		else if(statusSelectedValue === "æƒ³è¯»")
			selectStatus = 1;
		else if(statusSelectedValue === "åœ¨è¯»")
			selectStatus = 2;
		else if(statusSelectedValue === "è¯»è¿‡")
			selectStatus = 3;
		else
			selectStatus = 0;

		// [i][j] iç¬¬å‡ ä¸ª jç¬¬å‡ ä¸ªå±æ€§
		// console.log(bookTable.length); // æŸ¥æ‰¾ä¸ªæ•°  
		let cnt = 0;
		for(let i=0;i<bookTable.length;i++)
		{
			// ç­›é€‰æ‰€æœ‰ æˆ–è€… ç›¸åŒ
			if((selectStatus == 0) || (selectStatus == bookReadStatusArray[i]))
			{
				bookViewTable.push([]);
				for(let j=0;j<bookTable[i].length;j++)
				{
					bookViewTable[cnt].push(bookTable[i][j]);
				}
				if(bookReadStatusArray[i] == 3) // "âœ…è¯»è¿‡"
				{
					bookViewTable[cnt].push("âœ…è¯»è¿‡");
				}
				else if(bookReadStatusArray[i] == 2)
				{
					bookViewTable[cnt].push("ğŸ“†åœ¨è¯»");
				}
				else 
				{
					bookViewTable[cnt].push("ğŸ’¡æƒ³è¯»");
				}
				bookViewTable[cnt].push(bookReadTimesArray[i]);
				cnt = cnt + 1;
			}
			
		}

	} catch(e){ // æŠ¥é”™
		MSG.innerText = "[error] "+ e.message;
	}
	msg("åŒ¹é…ç»“æœ: " + bookViewTable.length);

	let md_table = dv.markdownTable(["å°é¢","ä¹¦å","ä½œè€…","è±†ç“£è¯„åˆ†","æ€»é¡µæ•°","æ ‡ç­¾","çŠ¶æ€","é˜…è¯»æ¬¡æ•°"], bookViewTable);
	if (data.length > 0) {
		dv.table(["å°é¢","ä¹¦å","ä½œè€…","è±†ç“£è¯„åˆ†","æ€»é¡µæ•°","æ ‡ç­¾","çŠ¶æ€","é˜…è¯»æ¬¡æ•°"], bookViewTable);
		// navigator.clipboard.writeText(md_table);
	  }
}

```


